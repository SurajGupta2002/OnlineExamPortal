{% extends 'base.html' %}
{% load static %}
{% block title %}{{ exam.title }} - Examination Hall{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6 min-h-[calc(100vh-200px)] mb-12 pb-10">
    <!-- Left: Question Section (Wizard Style) -->
    <div class="flex-grow flex flex-col h-full">
        <!-- Question Header -->
        <div class="bg-white border rounded-t-xl p-4 flex justify-between items-center shadow-sm">
            <h2 class="text-xl font-bold text-gray-800">
                Question <span id="currentNumberBadge"
                    class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg ml-2 text-sm">1</span>
            </h2>
            <div class="text-sm font-semibold text-gray-500">
                Correct Marks: <span class="text-green-600">+1.0</span> | Negative: <span
                    class="text-red-600">0.0</span>
            </div>
        </div>

        <!-- Question Body (Form) -->
        <form id="examForm" action="{% url 'submit_exam' attempt.id %}" method="post" class="flex-grow flex flex-col">
            {% csrf_token %}

            <div class="flex-grow bg-white border-x p-8 overflow-y-auto">
                {% for question in questions %}
                <div id="q_container_{{ forloop.counter0 }}" class="question-container hidden space-y-8 animate-fadeIn">
                    <p class="text-xl font-medium text-gray-800 leading-relaxed">
                        {{ question.text }}
                    </p>

                    <div class="space-y-4">
                        <label
                            class="flex items-center p-4 border rounded-xl hover:bg-indigo-50 cursor-pointer transition group border-gray-200"
                            onclick="updatePaletteState({{ forloop.counter0 }}, 'visited')">
                            <input type="radio" name="question_{{ question.id }}" value="1"
                                class="h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                                onchange="markAsAnswered({{ forloop.counter0 }})">
                            <span class="ml-4 text-gray-700 font-medium">{{ question.option1 }}</span>
                        </label>
                        <label
                            class="flex items-center p-4 border rounded-xl hover:bg-indigo-50 cursor-pointer transition group border-gray-200"
                            onclick="updatePaletteState({{ forloop.counter0 }}, 'visited')">
                            <input type="radio" name="question_{{ question.id }}" value="2"
                                class="h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                                onchange="markAsAnswered({{ forloop.counter0 }})">
                            <span class="ml-4 text-gray-700 font-medium">{{ question.option2 }}</span>
                        </label>
                        <label
                            class="flex items-center p-4 border rounded-xl hover:bg-indigo-50 cursor-pointer transition group border-gray-200"
                            onclick="updatePaletteState({{ forloop.counter0 }}, 'visited')">
                            <input type="radio" name="question_{{ question.id }}" value="3"
                                class="h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                                onchange="markAsAnswered({{ forloop.counter0 }})">
                            <span class="ml-4 text-gray-700 font-medium">{{ question.option3 }}</span>
                        </label>
                        <label
                            class="flex items-center p-4 border rounded-xl hover:bg-indigo-50 cursor-pointer transition group border-gray-200"
                            onclick="updatePaletteState({{ forloop.counter0 }}, 'visited')">
                            <input type="radio" name="question_{{ question.id }}" value="4"
                                class="h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                                onchange="markAsAnswered({{ forloop.counter0 }})">
                            <span class="ml-4 text-gray-700 font-medium">{{ question.option4 }}</span>
                        </label>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Question Footer: Navigation -->
            <div
                class="bg-gray-100 border-t p-6 flex flex-col sm:flex-row gap-4 justify-between items-center shadow-inner rounded-b-xl border-x">
                <div class="flex gap-3 w-full sm:w-auto">
                    <button type="button" onclick="navigate(-1)"
                        class="flex-1 sm:flex-initial px-6 py-3 bg-white border border-gray-300 rounded-xl text-gray-700 font-bold hover:bg-gray-50 active:scale-95 transition shadow-sm disabled:opacity-50"
                        id="prevBtn">Previous</button>
                    <button type="button" onclick="clearResponse()"
                        class="flex-1 sm:flex-initial px-6 py-3 bg-white border border-gray-300 rounded-xl text-red-600 font-bold hover:bg-red-50 active:scale-95 transition shadow-sm">Clear
                        Response</button>
                </div>
                <div class="flex gap-3 w-full sm:w-auto">
                    <button type="button" onclick="saveAndMark()"
                        class="flex-1 sm:flex-initial px-6 py-3 bg-white border-2 border-indigo-600 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 active:scale-95 transition shadow-sm">Review
                        Later</button>
                    <button type="button" onclick="saveAndNext()"
                        class="flex-1 sm:flex-initial px-10 py-3 bg-indigo-600 text-white rounded-xl font-extrabold hover:bg-indigo-700 active:scale-95 transition shadow-lg shadow-indigo-200"
                        id="nextBtn">Save & NEXT</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Right: Sidebar (Palette & Timer) -->
    <div class="w-full lg:w-80 flex flex-col gap-6">
        <!-- Profile & Timer -->
        <div class="bg-white border rounded-xl p-6 shadow-sm">
            <div class="flex items-center gap-4 mb-6">
                {% if user.profile.profile_pic %}
                <img src="{{ user.profile.profile_pic.url }}"
                    class="w-12 h-12 rounded-full border-2 border-indigo-100 object-cover shadow-sm">
                {% else %}
                <div
                    class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold text-xl ring-2 ring-indigo-50">
                    {{ user.username|first|upper }}
                </div>
                {% endif %}
                <div>
                    <p class="font-bold text-gray-800">{{ user.username }}</p>
                    <p class="text-xs text-green-500 flex items-center"><span
                            class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></span> Online</p>
                </div>
            </div>

            <div class="text-center border-t pt-4">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Remaining Time</p>
                <div id="timer" class="text-4xl font-mono font-black text-indigo-600">--:--</div>
            </div>
        </div>

        <!-- Question Palette -->
        <div class="bg-white border rounded-xl p-5 shadow-sm flex-grow">
            <h3 class="text-sm font-bold text-gray-700 mb-4 border-b pb-2 uppercase text-center">Question Palette</h3>
            <div class="grid grid-cols-5 gap-3 mb-6" id="paletteGrid">
                {% for i in questions %}
                <button type="button" onclick="goToQuestion({{ forloop.counter0 }})" id="pal_{{ forloop.counter0 }}"
                    class="w-10 h-10 rounded-md border-2 border-gray-100 bg-gray-50 flex items-center justify-center font-bold text-gray-400 hover:border-indigo-300 transition-all text-sm">
                    {{ forloop.counter }}
                </button>
                {% endfor %}
            </div>

            <!-- Legend -->
            <div class="grid grid-cols-2 gap-y-3 gap-x-1 text-[10px] font-bold uppercase text-gray-500 border-t pt-4">
                <div class="flex items-center"><span class="w-4 h-4 bg-green-500 rounded mr-2"></span> Answered</div>
                <div class="flex items-center"><span class="w-4 h-4 bg-red-500 rounded mr-2"></span> Not Answered</div>
                <div class="flex items-center"><span class="w-4 h-4 bg-blue-500 rounded mr-2"></span> Mark for Review
                </div>
                <div class="flex items-center"><span
                        class="w-4 h-4 bg-gray-100 border-2 border-gray-200 rounded mr-2"></span> Not Visited</div>
            </div>

            <button type="button" onclick="confirmSubmission()"
                class="w-full mt-8 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition shadow-lg shadow-red-200">
                Submit Test
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fadeIn {
        animation: fadeIn 0.3s ease-out;
    }

    .palette-not-visited {
        border-color: #f3f4f6;
        color: #9ca3af;
        background: #f9fafb;
    }

    .palette-not-answered {
        background: #ef4444 !important;
        color: white !important;
        border-color: #dc2626 !important;
    }

    .palette-answered {
        background: #22c55e !important;
        color: white !important;
        border-color: #16a34a !important;
    }

    .palette-marked {
        background: #3b82f6 !important;
        color: white !important;
        border-color: #2563eb !important;
    }

    .palette-current {
        border-color: #6366f1 !important;
        ring: 2px solid #6366f1;
        transform: scale(1.1);
    }
</style>

<script>
    let currentIdx = 0;
    const totalQuestions = {{ questions| length }};
    const questions = document.querySelectorAll('.question-container');
    const paletteBtns = document.querySelectorAll('#paletteGrid button');
    const currentBadge = document.getElementById('currentNumberBadge');

    // Store states: 'gray', 'red', 'green', 'blue'
    const qStates = new Array(totalQuestions).fill('gray');
    const qAnsweredData = new Array(totalQuestions).fill(null);

    function showQuestion(idx) {
        questions.forEach((q, i) => {
            q.classList.toggle('hidden', i !== idx);
            paletteBtns[i].classList.toggle('palette-current', i === idx);
        });

        currentIdx = idx;
        currentBadge.textContent = idx + 1;

        // Disable/Enable buttons
        document.getElementById('prevBtn').disabled = (idx === 0);
        const nextBtn = document.getElementById('nextBtn');
        if (idx === totalQuestions - 1) {
            nextBtn.textContent = "Finish & Review";
        } else {
            nextBtn.textContent = "Save & NEXT";
        }

        // If not visited yet, set to 'red' (waiting for answer)
        if (qStates[idx] === 'gray') {
            updatePaletteState(idx, 'red');
        }
    }

    function navigate(step) {
        let newIdx = currentIdx + step;
        if (newIdx >= 0 && newIdx < totalQuestions) {
            showQuestion(newIdx);
        }
    }

    function goToQuestion(idx) {
        showQuestion(idx);
    }

    function updatePaletteState(idx, state) {
        qStates[idx] = state;
        const btn = document.getElementById(`pal_${idx}`);

        btn.classList.remove('palette-not-visited', 'palette-not-answered', 'palette-answered', 'palette-marked');
        if (state === 'red') btn.classList.add('palette-not-answered');
        else if (state === 'green') btn.classList.add('palette-answered');
        else if (state === 'blue') btn.classList.add('palette-marked');
    }

    function markAsAnswered(idx) {
        qStates[idx] = 'green';
        updatePaletteState(idx, 'green');
    }

    function saveAndNext() {
        // Check if any radio in current question is checked
        const inputs = questions[currentIdx].querySelectorAll('input[type="radio"]');
        let answered = false;
        inputs.forEach(input => { if (input.checked) answered = true; });

        if (answered) {
            updatePaletteState(currentIdx, 'green');
        } else {
            updatePaletteState(currentIdx, 'red');
        }

        if (currentIdx < totalQuestions - 1) {
            navigate(1);
        } else {
            confirmSubmission();
        }
    }

    function saveAndMark() {
        updatePaletteState(currentIdx, 'blue');
        if (currentIdx < totalQuestions - 1) {
            navigate(1);
        }
    }

    function clearResponse() {
        const inputs = questions[currentIdx].querySelectorAll('input[type="radio"]');
        inputs.forEach(input => { input.checked = false; });
        updatePaletteState(currentIdx, 'red');
    }

    // Timer Logic
    let timeLeft = {{ time_remaining }};
    const timerDisplay = document.getElementById('timer');
    const examForm = document.getElementById('examForm');

    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        if (timeLeft <= 300) timerDisplay.classList.add('text-red-500'); // Final 5 mins

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            alert('Time is up! Your exam will be submitted automatically.');
            examForm.submit();
        }
        timeLeft--;
    }

    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    function confirmSubmission() {
        let answeredCount = 0;
        qStates.forEach(s => { if (s === 'green' || s === 'blue') answeredCount++; });

        let msg = `Summary:\nAnswered: ${answeredCount}\nUnanswered: ${totalQuestions - answeredCount}\n\nAre you sure you want to submit?`;
        if (confirm(msg)) {
            window.onbeforeunload = null;
            examForm.submit();
        }
    }

    window.onbeforeunload = function () {
        return "Exam in progress! Are you sure you want to leave?";
    };

    // Initialize
    showQuestion(0);
</script>
{% endblock %}